#!/bin/bash

# Define the Jenkins user and sudoers entry
USER="jenkins"
SUDOERS_ENTRY="$USER ALL=(ALL:ALL) NOPASSWD:ALL"

# Backup the existing sudoers file
echo "Backing up the existing sudoers file..."
sudo cp /etc/sudoers /etc/sudoers.bak

# Add the sudoers entry if it does not already exist
if ! sudo grep -q "^$SUDOERS_ENTRY" /etc/sudoers; then
    echo "Adding sudoers entry for $USER..."
    echo "$SUDOERS_ENTRY" | sudo tee -a /etc/sudoers > /dev/null
else
    echo "Sudoers entry for $USER already exists."
fi

# Validate the sudoers file
echo "Validating the sudoers file..."
if sudo visudo -c; then
    echo "Sudoers file is valid."
else
    echo "Sudoers file is invalid. Restoring the backup..."
    sudo mv /etc/sudoers.bak /etc/sudoers
    exit 1
fi

echo "Sudo privileges granted to $USER successfully."
